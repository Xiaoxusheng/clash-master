services:
  clash-master:
    image: foru17/clash-master:latest
    container_name: clash-master
    restart: unless-stopped
    ports:
      # 外部端口 : 内部端口
      # 如果端口被占用，修改 .env 文件或环境变量即可
      - "${WEB_EXTERNAL_PORT:-3000}:3000"   # Web UI
      - "${API_EXTERNAL_PORT:-3001}:3001"   # API
      - "${WS_EXTERNAL_PORT:-3002}:3002"    # WebSocket
    volumes:
      - ./data:/app/data
    environment:
      - NODE_ENV=production
      - WEB_PORT=3000
      - API_PORT=3001
      - COLLECTOR_WS_PORT=3002
      # 将外部端口传入容器，用于运行时前端配置
      - WEB_EXTERNAL_PORT=${WEB_EXTERNAL_PORT:-3000}
      - API_EXTERNAL_PORT=${API_EXTERNAL_PORT:-3001}
      - WS_EXTERNAL_PORT=${WS_EXTERNAL_PORT:-3002}
      - DB_PATH=/app/data/stats.db
    networks:
      - clash-master-network
    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:${API_PORT:-3001}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  clash-master-network:
    driver: bridge
